// Generated by CoffeeScript 1.9.3
var $, Board,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

$ = require('jquery');

Board = (function() {
  function Board(boardValues, goals, goalContainer, isMobile, Cell, Colors, ClickHandler, SolutionService, BoardSolvedService, RunningSum) {
    this.boardValues = boardValues;
    this.goals = goals;
    this.goalContainer = goalContainer;
    this.isMobile = isMobile;
    this.Cell = Cell;
    this.Colors = Colors;
    this.ClickHandler = ClickHandler;
    this.SolutionService = SolutionService;
    this.BoardSolvedService = BoardSolvedService;
    this.RunningSum = RunningSum;
    this.createEmptyCells = bind(this.createEmptyCells, this);
    this.initializer = bind(this.initializer, this);
    this.dimension = this.boardValues.length;
    this.initialValues = this.copyValues(this.boardValues);
    this.initializer();
  }

  Board.prototype.createBoard = function() {
    var col, gridCell, gridElem, gridRow, i, j, ref, ref1, row;
    gridElem = $('#grid-container');
    for (row = i = 0, ref = this.dimension; 0 <= ref ? i < ref : i > ref; row = 0 <= ref ? ++i : --i) {
      gridRow = '<div id="grid-row-' + row + '" class="grid-row"></div>';
      gridElem.append(gridRow);
      for (col = j = 0, ref1 = this.dimension; 0 <= ref1 ? j < ref1 : j > ref1; col = 0 <= ref1 ? ++j : --j) {
        gridCell = '<div id="grid-cell-' + row + '-' + col + '" class="grid-cell"></div>';
        $('#grid-row-' + row).append(gridCell);
        $('#grid-cell-' + row + '-' + col).css(this.gridCellStyle);
      }
    }
    return this.createCells(this.dimension);
  };

  Board.prototype.setGridStyling = function() {
    var fieldWidth, gridSpacing, tileSize;
    gridSpacing = 15;
    fieldWidth = Math.min(Math.max($(window).width(), 310), 500);
    tileSize = (fieldWidth - gridSpacing * (this.dimension + 1)) / this.dimension;
    this.gridCellStyle = {
      width: tileSize,
      height: tileSize,
      "line-height": tileSize + "px"
    };
    return $('#game-container').css({
      width: fieldWidth,
      height: fieldWidth
    });
  };

  Board.prototype.bindCellsClick = function() {
    var col, i, ref, results, row;
    results = [];
    for (row = i = 0, ref = this.dimension; 0 <= ref ? i < ref : i > ref; row = 0 <= ref ? ++i : --i) {
      results.push((function() {
        var j, ref1, results1;
        results1 = [];
        for (col = j = 0, ref1 = this.dimension; 0 <= ref1 ? j < ref1 : j > ref1; col = 0 <= ref1 ? ++j : --j) {
          results1.push($('#cell-' + row + '-' + col).click((function(_this) {
            return function(e) {
              var distance, num;
              e.preventDefault();
              num = 2;
              distance = num * _this.dropDownDistance;
              $(e.currentTarget).css("color", "blue");
              return console.log($(e.currentTarget).text());
            };
          })(this)));
        }
        return results1;
      }).call(this));
    }
    return results;
  };

  Board.prototype.createCells = function() {
    var cell, cellRow, col, containerElem, i, ref, results, row;
    this.cells = [];
    containerElem = $('#cell-container');
    results = [];
    for (row = i = 0, ref = this.dimension; 0 <= ref ? i < ref : i > ref; row = 0 <= ref ? ++i : --i) {
      this.cells.push([]);
      cellRow = '<div id="cell-row-' + row + '" class="cell-row"></div>';
      containerElem.append(cellRow);
      results.push((function() {
        var j, ref1, results1;
        results1 = [];
        for (col = j = 0, ref1 = this.dimension; 0 <= ref1 ? j < ref1 : j > ref1; col = 0 <= ref1 ? ++j : --j) {
          cell = new this.Cell(col, row, this, this.clickHandler, this.boardValues[row][col], this.gridCellStyle);
          results1.push(this.cells[row].push(cell));
        }
        return results1;
      }).call(this));
    }
    return results;
  };

  Board.prototype.clearBoardElem = function() {
    $('#grid-container').empty();
    return $('#cell-container').empty();
  };

  Board.prototype.initializer = function() {
    var solutionService;
    solutionService = new this.SolutionService(this, this.goals);
    this.clickHandler = new this.ClickHandler(this, solutionService, this.goalContainer, this.isMobile, this.BoardSolvedService, this.RunningSum);
    this.setGridStyling();
    this.createBoard();
    return this.clickHandler.bindDefaultMouseEvents();
  };

  Board.prototype.createEmptyCells = function(width) {
    var cell, col, i, ref, results, row;
    this.empty_cells = [];
    results = [];
    for (row = i = 0, ref = this.dimension; 0 <= ref ? i < ref : i > ref; row = 0 <= ref ? ++i : --i) {
      this.empty_cells.push([]);
      results.push((function() {
        var j, ref1, results1;
        results1 = [];
        for (col = j = 0, ref1 = this.dimension; 0 <= ref1 ? j < ref1 : j > ref1; col = 0 <= ref1 ? ++j : --j) {
          cell = new this.Cell(col, row, width, this.scene, this);
          cell.setColor(this.Colors.emptyCell);
          cell.setBorder(this.Colors.emptyCellBorder);
          results1.push(this.empty_cells[row].push(cell));
        }
        return results1;
      }).call(this));
    }
    return results;
  };

  Board.prototype.deleteCells = function(solution) {
    var i, len, tuple;
    for (i = 0, len = solution.length; i < len; i++) {
      tuple = solution[i];
      this.deleteCellAt(tuple.x, tuple.y);
    }
    return this.pushAllCellsToBottom();
  };

  Board.prototype.deleteCellAt = function(x, y) {
    this.boardValues[y][x] = ' ';
    return this.cells[y][x]["delete"]();
  };

  Board.prototype.pushAllCellsToBottom = function() {
    var col, i, j, k, ref, ref1, ref2, row, up;
    for (row = i = ref = this.dimension - 1; ref <= 1 ? i <= 1 : i >= 1; row = ref <= 1 ? ++i : --i) {
      for (col = j = ref1 = this.dimension - 1; ref1 <= 0 ? j <= 0 : j >= 0; col = ref1 <= 0 ? ++j : --j) {
        if (this.cells[row][col].isDeleted) {
          for (up = k = ref2 = row - 1; ref2 <= 0 ? k <= 0 : k >= 0; up = ref2 <= 0 ? ++k : --k) {
            if (!this.cells[up][col].isDeleted) {
              this.swapCells(row, col, up, col);
              break;
            }
          }
        }
      }
    }
    return this.scene.update();
  };

  Board.prototype.swapCells = function(r1, c1, r2, c2) {
    var temp;
    this.cells[r1][c1].shiftTo(r2, c2);
    this.cells[r2][c2].shiftTo(r1, c1);
    temp = this.cells[r1][c1];
    this.cells[r1][c1] = this.cells[r2][c2];
    this.cells[r2][c2] = temp;
    temp = this.boardValues[r1][c1];
    this.boardValues[r1][c1] = this.boardValues[r2][c2];
    return this.boardValues[r2][c2] = temp;
  };

  Board.prototype.copyValues = function(source) {
    var col, dest, i, j, ref, ref1, row;
    dest = [];
    for (row = i = 0, ref = this.dimension; 0 <= ref ? i < ref : i > ref; row = 0 <= ref ? ++i : --i) {
      dest.push([]);
      for (col = j = 0, ref1 = this.dimension; 0 <= ref1 ? j < ref1 : j > ref1; col = 0 <= ref1 ? ++j : --j) {
        dest[row].push(source[row][col]);
      }
    }
    return dest;
  };

  Board.prototype.resetBoard = function() {
    this.clearBoardElem();
    this.boardValues = this.copyValues(this.initialValues);
    this.goalContainer.resetGoals();
    return this.initializer();
  };

  return Board;

})();

module.exports = Board;
